<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Trip Tracker - FemDrive</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: system-ui, sans-serif; }
    #map { width: 100%; height: 100%; }
    #status {
      position: absolute; top: 16px; left: 16px; right: 16px;
      background: #ff4444; color: white; padding: 12px; border-radius: 8px;
      text-align: center; z-index: 1000; display: none; font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="status"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBEbRIB7WEQRE84HxH0CH_V8WOoHUnIPd8",
      authDomain: "ridesharefyp-0022.firebaseapp.com",
      databaseURL: "https://ridesharefyp-0022-default-rtdb.firebaseio.com",
      projectId: "ridesharefyp-0022",
      storageBucket: "ridesharefyp-0022.firebasestorage.app",
      messagingSenderId: "278929890705",
      appId: "1:278929890705:web:9066d1a6a34159ac3ece30"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const shareId = window.location.pathname.split('/').pop();
    const status = document.getElementById('status');

    if (!shareId || shareId === 'trip') {
      status.innerText = 'Invalid trip link. Please check the shared URL.';
      status.style.display = 'block';
      document.title = 'Invalid Trip';
      throw new Error('Invalid shareId');
    }

    const map = L.map('map', {
      zoomControl: true, dragging: true, touchZoom: true, doubleClickZoom: true,
      scrollWheelZoom: true, boxZoom: true, keyboard: true
    }).setView([33.6844, 73.0479], 6); // Default: Islamabad

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);

    let marker = null;
    let firstLocation = true;

    const locationRef = ref(db, `trip_shares/${shareId}`);
    onValue(locationRef, (snapshot) => {
      const data = snapshot.val();
      if (!data || data.lat == null || data.lng == null) {
        status.innerText = 'Waiting for location update...';
        status.style.display = 'block';
        return;
      }

      const now = Date.now();
      const updatedAt = data.updatedAt || 0;
      const age = Math.floor((now - updatedAt) / (1000 * 60)); // Minutes
      const speed = data.speed || 0;

      if (age > 5) { // 5-minute timeout
        status.innerText = 'Location outdated (>5 min)';
        status.style.display = 'block';
        return;
      }

      const pos = [parseFloat(data.lat), parseFloat(data.lng)];
      if (isNaN(pos[0]) || isNaN(pos[1])) {
        status.innerText = 'Invalid location data';
        status.style.display = 'block';
        return;
      }

      if (marker) {
        marker.setLatLng(pos);
      } else {
        marker = L.marker(pos, {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/32/3082/3082383.png',  // Local asset
            iconSize: [32, 32]
          })
        }).addTo(map)
          .bindPopup(`<b>FemDrive Driver</b><br>${speed.toFixed(1)} km/h<br>${age === 0 ? 'Just now' : age + ' min ago'}`)
          .openPopup();
      }

      if (firstLocation) {
        map.setView(pos, 16);
        firstLocation = false;
      } else {
        map.panTo(pos, { animate: true, duration: 1.5 });
      }

      status.style.display = 'none';
      document.title = `Trip â€¢ ${speed.toFixed(1)} km/h`;
    }, (err) => {
      console.error('RTDB Error:', err);
      status.innerText = `Connection error: ${err.message}`;
      status.style.display = 'block';
    });

    window.addEventListener('beforeunload', () => off(locationRef));
    status.innerText = 'Connecting to live location...';
    status.style.display = 'block';
  </script>
</body>
</html>